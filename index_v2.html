<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
        @font-face {
			font-family: "Roboto-Thin";
			src: url("fonts/Roboto-Thin.ttf");
        }
        
        @font-face {
			font-family: "Roboto-ThinItalic";
			src: url("fonts/Roboto-ThinItalic.ttf");
        }
        
        @font-face {
			font-family: "Roboto-Light";
			src: url("fonts/Roboto-Light.ttf");
        }
        
        body{
			background: #ececec;
			font-family: "Roboto-Light";
        }
        
        #linechart {
            height: 380px;
            width: 41%;
            margin: 0 auto;
            margin-top: 15px;
            display: inline-block;
        }
		
        #comebackChart {
            height: 360px;
            width: 41%;
            margin: 0 auto;
            display: inline-block;
        }
		
        .overlay {
            fill: none;
            /*pointer-events: all;*/
        }
		
        text {
            font-size: 10px;
            font-family: sans-serif;
        }
        .legend-text {
            font-size: 11px;
        }
		
        .filter {
            margin: auto;
            width: 300px;
        }
	    
        div.tooltip {
            position: absolute;
            padding: 5px;
            font: 11px monospace;
            background: #b3cccc;
            border: 0px;
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.29);
            pointer-events: none;
        }
		
        .fade_rule {
			height: 1px;
			background-color: #E6E6E6;
			width: 90%;
			margin: 0 auto;
			background-image: linear-gradient(left , white 2%, black 50%, white 98%);
			background-image: -o-linear-gradient(left , white 2%, black 50%, white 98%);
			background-image: -moz-linear-gradient(left , white 2%, black 50%, white 98%);
			background-image: -webkit-linear-gradient(left , white 2%, black 50%, white 98%);
			background-image: -ms-linear-gradient(left , white 2%, black 50%, white 98%);
			background-image: -webkit-gradient( linear, left bottom, right bottom, color-stop(0.02, white), color-stop(0.5, black), color-stop(0.98, white) );
        }
        
        
        .left_fade_rule {
			height: 1px;
			background-color: #E6E6E6;
			width: 100%;
			margin: 5px auto;
			margin-bottom: 15px;
			background-image: linear-gradient(left , #525252 2%, #c7c7c7 50%, white 98%);
			background-image: -o-linear-gradient(left , #525252 2%, #c7c7c7 50%, white 98%);
			background-image: -moz-linear-gradient(left , #525252 2%, #c7c7c7 50%, white 98%);
			background-image: -webkit-linear-gradient(left , #525252 2%, #c7c7c7 50%, white 98%);
			background-image: -ms-linear-gradient(left , #525252 2%, #c7c7c7 50%, white 98%);
			background-image: -webkit-gradient( linear, left bottom, right bottom, color-stop(0.02, #525252), color-stop(0.5, #c7c7c7), color-stop(0.98, white) );
        }
        .card{
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.29);
            background: white;
            font-size: 18px;
            text-align: justify;
        }
        
        .title{
            font-size: 26px;
            margin-bottom: 10px;
            font-style: italic;
        }
		
		.slope-line {
			stroke-width: 2px;
			stroke-linecap: round;
		}
    
		.slope-label-left, .slope-label-right {
			font-size: 16px;
			cursor: default;
			font-weight: 350;
		}
    
		.label-figure {
			font-weight: 700;
		}
    
		.border-lines {
			stroke: #999;
			stroke-width: 1px;
		}
    
		.voronoi path {
			fill: none;
			pointer-events: all;
		}
    </style>

    <style>
        .slider {
			-webkit-appearance: none;
			width: 100%;
			height: 25px;
			background: #d3d3d3;
			outline: none;
			opacity: 0.7;
			-webkit-transition: .2s;
			transition: opacity .2s;
		}

		.slider:hover {
			opacity: 1;
		}

		.slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 25px;
			height: 25px;
			background: #4CAF50;
			cursor: pointer;
		}

		.slider::-moz-range-thumb {
			width: 25px;
			height: 25px;
			background: #4CAF50;
			cursor: pointer;
		}
	</style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body>
    <div style="text-align: center; font-size: 40px; font-style: italic; margin-bottom: 5px">Top Clubs and Comeback Kings of Europe</div>
    <div class="fade_rule"></div>

    <div class="card">
        <span class="title">Introduction</span>
        <div class="left_fade_rule"></div>
        From a fan's perspective, comebacks are one of the most exhilarating things in football. Who wouldn't love watching the team they support go from 0-2 down to win 3-2 with the last kick of the game? (The opponent maybe?). Even the players themselves get a rush from such a dramatic finish. The goal of this article is to determine which club in world football deserves the title of “Comeback Kings” and what statistics aid in this cause. Every club wants it, but surely only a few deserve the title.
    </div>

    <div class="card" style="width: 52%; display: inline-block; vertical-align: top; margin-top: 15px;">
        <span class="title">"Big" Clubs</span>
        <div style='height: 2px;' class="left_fade_rule"></div>
        Before we look into comebacks, let's determine the biggest clubs in football. We match up teams from the top 5 super leagues in Europe, all the way from the 1994-95 season. Hover over seasons to see which teams dominated different eras. Barcelona, Real Mardid, Manchester United, Bayern and Juventus make up the top 5 teams based on league wins across all these divisions. Pretty much expected, but there are still a few interesting stories here...
        <div class="">

            <div id="myCarousel" class="carousel slide" data-ride="carousel">
                <!-- Indicators -->
                <ol style="bottom: -20px;" class="carousel-indicators">
                    <li style="background: #7d7b7b;" data-target="#myCarousel" data-slide-to="0" class="active"></li>
                    <li style="background: #7d7b7b;" data-target="#myCarousel" data-slide-to="1"></li>
                    <li style="background: #7d7b7b;" data-target="#myCarousel" data-slide-to="2"></li>
                </ol>

                <!-- Wrapper for slides -->
                <div class="carousel-inner">
                    <div class="item active" style="text-align: center">
                        <div class="card" style="width: 95%; display: inline-block; vertical-align: top; margin-top: 15px;">
                            <b>Roman Abramovich Era -</b> In 2003, Chelsea was bought over by Russian billionaire Roman Abramovich. Since then, over $2.5 billion was spent in transfer fees and player salaries resulting in 6 league titles. 
                        </div>
                    </div>

                    <div class="item" style="text-align: center">
                        <div class="card" style="width: 95%; display: inline-block; vertical-align: top; margin-top: 15px;">
                            <b>Italian Football Scandal -</b> In May 2006, Juventus became one of the five clubs linked to rigging Serie A games, the result of which saw the club relegated to Serie B for the first time in its history.
                        </div>
                    </div>

                    <div class="item" style="text-align: center">
                        <div class="card" style="width: 95%; display: inline-block; vertical-align: top; margin-top: 15px;">
                            <b>Post Sir Alex Ferguson Era -</b> In 2013, the most successful manager in English football retired from managing the most successful club in English football. Since then, Manchester United's win % has fallen to 60% from 67%. 
                        </div>
                    </div>
                </div>

                <!-- Left and right controls -->
                <a style="background: #ffffff00; !important; width: auto;" class="left carousel-control" href="#myCarousel" data-slide="prev">
                    <span style="color: black;" class="glyphicon glyphicon-chevron-left"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a style="background: #ffffff00; !important; width: auto;" class="right carousel-control" href="#myCarousel" data-slide="next">
                    <span style="color: black;" class="glyphicon glyphicon-chevron-right"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>
    </div>

    <div id="linechart"></div>
    <div class="filter"> Filter for top <input step="5" id="topFilter" class="slider" value=10 type="range" min="1" max="227">
        <p>Value: <span id="filterValue"></span></p>
    </div>
    <div style="width: 52%; display: inline-block; vertical-align: top; margin-top: 15px;">
    <div class="card" style="display: inline-block; vertical-align: top; margin-top: 15px;">
        <span class="title">Comebacks with that winning mentality</span>
        <div style='height: 2px;' class="left_fade_rule"></div>
        Now that we got that out of the way, lets focus on the 10 biggest clubs. (Sorry fans of other clubs. Your teams just aren't big enough in history. Maybe soon?) Lets match them up based on the number of comebacks completed vs the number of wins over time. A comeback king is a team that customarily wins, but when faced with the rare obstacle of traling, digs down deep to grab that excusive comeback. They should stick out on the top right corner of the graph.
    </div>
    <div class="card" style="display: inline-block; vertical-align: top; margin-top: 5px;">
        <span class="title">What causes comebacks? (Or what doesn't)</span>
        <div style='height: 2px;' class="left_fade_rule"></div>
        Analysing these teams, lets try and figure out why they achieve so many comebacks. Could it be change in possesion stats, attempting more shots on goal or opponents loosing their nerve and commiting more fouls. 
        Fascinating to see that shots on goal amost doubled on average for all these teams during their comebacks. Most of these teams also draw alot more fouls during their comeback. This could be due to opponents not being able to handle the pressure. Most surprising is the fact that possession remains almost same before and after a comeback, meaning teams don't need to hold the ball longer to start their fightback.
    
    </div>
        </div>
    <div id="comebackChart"></div>
    <script>
        var slider = document.getElementById("topFilter");
        var output = document.getElementById("filterValue");
        output.innerHTML = slider.value - 1;
        slider.oninput = function() {
            output.innerHTML = this.value - 1;
        }

    </script>
    <script>
        let dataBank = {}
        let bymonth = {}
        let dataSet = []
        var formatTime = d3.timeFormat("%m/%Y");
        var parseDate = d3.timeParse("%m/%Y");
        var parseNewDate = d3.timeParse("");
        var teamTotals = {}
        var teamDivs = {}
        var seasons = []
        var topFilter = 11
        var div = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
        var standingsDiv = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);


        function sortByDateAscending(a, b) {
            // Dates will be cast to numbers automagically:
            return new Date(a.Date) - new Date(b.Date);
        }

        function loadData2() {
            d3.csv("allLeaguesData2.csv", function(data) {
                //data.map(groupmonth)
                data = data.sort(sortByDateAscending)
                for (var k = 0; k < data.length; k++) {
                    teamTotals[data[k].teamWon] = [0, 0, 0]
                    teamTotals[data[k].comeback] = [0, 0, 0]
                }
                for (var i = 0; i < data.length; i++) {
                    teamDivs[data[i].teamWon] = data[i].Div
                    dKey = data[i].Season
                    if (dKey == "1995-1996") {
                        if (dKey in dataBank) {
                            if (data[i].teamWon in dataBank[dKey]) {
                                teamTotals[data[i].teamWon][0] += 1
                            } else {
                                teamTotals[data[i].teamWon][0] = 1
                            }
                            if (data[i].comeback in dataBank[dKey]) {
                                teamTotals[data[i].comeback][1] += 1
                            } else {
                                teamTotals[data[i].comeback][1] = 1
                            }
                        } else {
                            dataBank[dKey] = {}
                            teamTotals[data[i].teamWon][0] = 1
                            teamTotals[data[i].comeback][1] = 1
                        }
                        teamTotals[data[i].comeback][2] += parseInt(data[i].margin)
                        dataBank[dKey] = JSON.parse(JSON.stringify(teamTotals))
                    } else {
                        if (dKey in dataBank) {
                            if (data[i].teamWon in dataBank[dKey]) {
                                teamTotals[data[i].teamWon][0] += 1
                            } else {
                                if (data[i].teamWon in teamTotals) {
                                    teamTotals[data[i].teamWon][0] += 1
                                } else {
                                    teamTotals[data[i].teamWon][0] = 1
                                }
                            }
                            if (data[i].comeback in dataBank[dKey]) {
                                teamTotals[data[i].comeback][1] += 1
                            } else {
                                if (data[i].comeback in teamTotals) {
                                    teamTotals[data[i].comeback][1] += 1
                                } else {
                                    teamTotals[data[i].comeback][1] = 1
                                }
                            }
                        } else {
                            dataBank[dKey] = {}
                            if (data[i].teamWon in teamTotals) {
                                teamTotals[data[i].teamWon][0] += 1
                            } else {
                                teamTotals[data[i].teamWon][0] = 1
                            }
                            if (data[i].comeback in teamTotals) {
                                teamTotals[data[i].comeback][1] += 1
                            } else {
                                teamTotals[data[i].comeback][1] = 1
                            }
                        }
                        teamTotals[data[i].comeback][2] += parseInt(data[i].margin)
                        dataBank[dKey] = JSON.parse(JSON.stringify(teamTotals))
                    }
                }
                var dateKeys = Object.keys(dataBank)
                seasons = dateKeys
                for (var j = 0; j < dateKeys.length; j++) {
                    //console.log(parseDate(dateKeys[j]))
                    var json = {
                        "season": dateKeys[j]
                    }
                    delete dataBank[dateKeys[j]]["False"]
                    delete dataBank[dateKeys[j]]["Blank"]
                    var mergedJson = Object.assign(json, dataBank[dateKeys[j]]);
                    dataSet.push(mergedJson)
                }
                //console.log(dataSet)
                drawGraph()
                drawComebackGraph()
                createHTML("2005-2006")
            });
        }
        loadData2()
        //var top10Teams = ["Real Madrid", "Barcelona", "Man United", "Bayern Munich", 'Juventus', 'Arsenal', 'Chelsea', 'Inter', 'Lyon', 'Liverpool']
        function getTopSet(year) {
            return Object.keys(dataBank[year]).sort(function(a, b) {
                return dataBank[year][b][0] - dataBank[year][a][0]
            })
        }

        function createHTML(year) {
            var top10Teams = getTopSet(year)
            var html = "Season " + year
            for (var i = 0; i < 10; i++) {
                //htmlValues.push(dataBank[year][top10Teams[i]][0])
                html = html + "<br> " + top10Teams[i] + ": " + dataBank[year][top10Teams[i]][0]
            }
            return html
        }

        function drawGraph() {
            var svg = d3.select('#linechart').append('svg').attr('height', '100%').attr('width', '100%').attr('display', 'inline-block');
            var yValues = [];
            var xValues = [];
            var marginValues = [];
            dataSet.forEach(function(d) {
                for (key in d) {
                    if (key !== 'season') {
                        yValues.push(d[key][0]);
                    }
                }
            });
            var yMin = d3.min(yValues, function(d, i) {
                return d;
            });
            var yMax = d3.max(yValues, function(d, i) {
                return d;
            });
            var xScale = d3.scaleBand()
                .domain(seasons)
                .range([40, 550]);
            xScale.invert = (function() {
                var domain = xScale.domain()
                var range = xScale.range()
                var scale = d3.scaleQuantize().domain(range).range(domain)
                return function(x) {
                    return scale(x)
                }
            })()
            var yScale = d3.scaleLinear()
                .domain([yMin, yMax])
                .range([300, 2]);
            var xAxis = d3.axisBottom(xScale);
            var yAxis = d3.axisLeft(yScale);
            var xAxisG = svg.append('g')
                .attr('id', 'xAxisG')
                .attr('transform', 'translate(-14,300)')
                .call(xAxis)
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr('transform', 'rotate(-65)');
            var yAxisG = svg.append('g')
                .attr('id', 'yAxisG')
                .attr('transform', 'translate(40,0)')
                .call(yAxis);
            svg.append("text")
                .attr('transform', 'translate(300,370)')
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("Span of Years");
            svg.append("text")
                .attr('transform', 'translate(10,150)rotate(-90)')
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("Total Number of Wins");

            var color = {
                'Liverpool': '#4d4d4d',
                'Man United': '#5da5da',
                'Arsenal': '#faa43a',
                'Barcelona': '#60bd68',
                'Real Madrid': '#f17cb0',
                'Inter': '#b2912f',
                'Lyon': '#b276b2',
                'Juventus': '#decf3f',
                'Chelsea': '#f15854',
                'Bayern Munich': '#1f77b4'
            }
            var linesG = svg.append('g');
            var legend = svg.append('g')
                .attr('id', 'legend')
                .attr('transform', 'translate(60, 250)')
                .style('opacity', '0');
            for (var i = 0; i < 5; i++) {
                legend.append('rect')
                    .attr('class', 'legend-text')
                    .attr('fill', color[Object.keys(color)[i]])
                    .attr('x', function() {
                        return 60 * i + 120;
                    })
                    .attr('height', 20)
                    .attr('width', 20)
                    .attr('y', 5);
                legend.append('text')
                    .attr('id', 'text' + Object.keys(color)[i])
                    .attr('class', 'legend-text')
                    .attr('fill', 'black')
                    .attr('x', function() {
                        return 60 * i + 143;
                    })
                    .attr('y', 20);
            }
            var dateText = legend.append('text')
                .attr('id', 'date-text')
                .attr('class', 'legend-text')
                .attr('x', 0)
                .attr('y', 20);
            var lines = {};
            var paths = {};
            var index = Object.keys(dataSet[0]).length - 1;

            function drawLines() {
                var colorline = 0
                for (key in dataSet[0]) {
                    if (key !== 'season') {
                        var line = d3.line()
                            .x(function(d) {
                                return xScale(d.season);
                            })
                            .y(function(d) {
                                return yScale(d[key][0]);
                            })
                            .curve(d3.curveCatmullRom.alpha(0.5));
                        lines[key] = line;
                        path = linesG.append('path')
                            .attr('d', line(dataSet))
                            .attr('id', key.replace(/^[^a-z]+|[^\w:.-]+/gi, ""))
                            .attr('title', key)
                            .attr('fill', 'none')
                            .attr('z-index', 10000)
                            .on("mouseover", mouseover)
                            .on("mouseout", mouseout)
                            //.on("mousemove", mousemove)
                            .attr('stroke', function(d) {
                                colorline += 1;
                                return color[key];
                            })
                            .attr('stroke-width', 1);
                        var totalLength = path.node().getTotalLength();
                        path
                            .attr('stroke-dasharray', totalLength + ' ' + totalLength)
                            .attr('stroke-dashoffset', totalLength)
                            .transition()
                            .duration(9000)
                            .ease(d3.easeCubicInOut)
                            .attr('stroke-dashoffset', 0);
                        paths[key] = path;
                        index--;
                    }
                }
                filterLines(topFilter)
            }
            drawLines()
            svg.append("circle") // Uses the enter().append() method
                .attr("class", "highLightSvg") // Assign a class for styling
                .attr("cx", function(d, i) {
                    return xScale("2006-2007")
                })
                .attr("cy", function(d) {
                    return yScale(235)
                })
                .attr("r", 1)
                .attr("opacity", 1)
            
            $("#myCarousel").on('slide.bs.carousel', function() {
                var currSlide = $('div.active').index()+1
                console.log(currSlide)
                highlight(currSlide)
            });

            function highlight(ind) {
                if (ind == 1) {
                    console.log("in")
                    for (k in teamTotals) {
                        kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                        d3.select('#' + kId).style('opacity', '0.25')
                        d3.select('#' + kId).style('pointer-events', 'all')
                    }
                    filterLines(topFilter)
                    d3.select('#Juventus').style('opacity', '1')
                    d3.selectAll('.highLightSvg')
                        .transition()
                        .duration(1000)
                        .attr("r", 40)
                        .attr('opacity', '1')
                        .attr("cx", function(d, i) {
                            return xScale("2005-2006")
                        })
                        .attr("cy", function(d) {
                            return yScale(235)
                        })
                        .attr('fill', 'rgb(73, 195, 177)')
                        .attr('fill-opacity', 0.3)
                        .attr('title', 'highLightSvg')
                        .attr('stroke', 'rgb(73, 195, 177)')
                        .attr("id", 'highLightSvg')
                        .on("end", function() {
                            d3.selectAll('.highLightSvg')
                                .transition()
                                .duration(2000)
                                .attr("r", 25)    
                        })

                }
                else if (ind == 3) {
                    console.log("in")
                    for (k in teamTotals) {
                        kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                        d3.select('#' + kId).style('opacity', '0.25')
                        d3.select('#' + kId).style('pointer-events', 'all')
                    }
                    filterLines(topFilter)
                    d3.select('#Chelsea').style('opacity', '1')
                    d3.selectAll('.highLightSvg')
                        .transition()
                        .duration(1000)
                        .attr("r", 40)
                        .attr('opacity', '1')
                        .attr("cx", function(d, i) {
                            return xScale("2003-2004")
                        })
                        .attr("cy", function(d) {
                            return yScale(160)
                        })
                        .attr('fill', 'rgb(73, 195, 177)')
                        .attr('fill-opacity', 0.3)
                        .attr('title', 'highLightSvg')
                        .attr('stroke', 'rgb(73, 195, 177)')
                        .attr("id", 'highLightSvg')
                        .on("end", function() {
                            d3.selectAll('.highLightSvg')
                                .transition()
                                .duration(2000)
                                .attr("r", 25)    
                        })

                }
                else if (ind == 2) {
                    console.log("in")
                    for (k in teamTotals) {
                        kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                        d3.select('#' + kId).style('opacity', '0.25')
                        d3.select('#' + kId).style('pointer-events', 'all')
                    }
                    filterLines(topFilter)
                    d3.select('#ManUnited').style('opacity', '1')
                    d3.selectAll('.highLightSvg')
                        .transition()
                        .duration(1000)
                        .attr("r", 40)
                        .attr('opacity', '1')
                        .attr("cx", function(d, i) {
                            return xScale("2015-2016")
                        })
                        .attr("cy", function(d) {
                            return yScale(510)
                        })
                        .attr('fill', 'rgb(73, 195, 177)')
                        .attr('fill-opacity', 0.3)
                        .attr('title', 'highLightSvg')
                        .attr('stroke', 'rgb(73, 195, 177)')
                        .attr("id", 'highLightSvg')
                        .on("end", function() {
                            d3.selectAll('.highLightSvg')
                                .transition()
                                .duration(2000)
                                .attr("r", 25)    
                        })

                }
            }
            const focus = svg.append('g')
                .attr('class', 'focus')
                .style('z-index', -1)
                .style('opacity', 1);
            focus.append('circle')
                .attr('r', 2.5);
            focus.append('line')
                .classed('x', true);
            focus.append('line')
                .classed('y', true);
            d3.selectAll('.focus')
                .style('opacity', 0.7);
            d3.selectAll('.focus circle')
                .style('fill', 'none')
                .style('stroke', 'black');
            d3.selectAll('.focus line')
                .style('fill', 'none')
                .style('stroke', 'black')
                .style('stroke-width', '1.5px')
                .style('stroke-width', '1.5px')
                .style('stroke-dasharray', '3 3');

            var mouseG = svg.append("g")
                .attr("class", "mouse-over-effects");
            mouseG.append("path") // this is the black vertical line to follow mouse
                .attr("class", "mouse-line")
                .style("stroke", "black")
                .style("stroke-width", "1px")
                .style('stroke-dasharray', '3 3')
                .style("opacity", "0");
            var height = 450
            var width = 550
            mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
                .attr('width', width) // can't catch mouse events on a g element
                .attr('height', height)
                .attr('x', 40)
                .attr('fill', 'none')
                .attr('pointer-events', 'all')
                .on('mouseout', function() { // on mouse out hide line, circles and text
                    d3.select(".mouse-line")
                        .style("opacity", "0");
                    d3.selectAll(".mouse-per-line circle")
                        .style("opacity", "0");
                    d3.selectAll(".mouse-per-line text")
                        .style("opacity", "0");
                    standingsDiv.style("opacity", 0);
                })
                .on('mouseover', function() { // on mouse in show line, circles and text
                    d3.select(".mouse-line")
                        .style("opacity", "0.7");
                    d3.selectAll(".mouse-per-line circle")
                        .style("opacity", "0.7");
                    d3.selectAll(".mouse-per-line text")
                        .style("opacity", "0.7");
                })
                .on('mousemove', function() { // mouse moving over canvas
                    var mouse = d3.mouse(this);
                    var season = xScale.invert(mouse[0])
                    var x = xScale(season)
                    d3.select(".mouse-line")
                        .attr("d", function() {
                            var d = "M" + x + "," + height;
                            d += " " + x + "," + 0;
                            return d;
                        });
                    standingsDiv.transition()
                        .duration(200)
                        .style("opacity", .9);
                    standingsDiv.html(createHTML(season))
                        .style("left", (x + 800) + "px")
                        .style("top", 400 + "px");
                })
            //svg.on("mousemove", mousemove)
            var zoom = d3.zoom()
                .scaleExtent([1, 10])
                .on('zoom', zoomed);
            //svg.call(zoom);
            function zoomed() {
                console.log('zoomed');
                xScale = d3.event.transform.rescaleX(xScale);
                xAxisG.call(xAxis.scale(d3.event.transform.rescaleX(xScale)));
                for (key in dataSet[0]) {
                    if (key !== 'season') {
                        line = lines[key];
                        path = paths[key];
                        totalLength = path.node().getTotalLength();
                        path
                            .attr('stroke-dasharray', totalLength + ' ' + totalLength)
                            .attr('stroke-dashoffset', totalLength)
                            .attr('stroke-dashoffset', 0);
                        path.attr('d', line(dataSet));
                        path.attr('clip-path', 'url(#clip)');
                    }
                }
            }
            var bisectDate = d3.bisector(function(d) {
                return d.season;
            }).left;

            function mousemove() {
                var x = d3.mouse(this)[0];
                var team = d3.select(this).attr('title')
                var season = xScale.invert(d3.mouse(this)[0])
                focus.style('opacity', 0.8)
                focus.attr('transform', "translate(" + d3.mouse(this)[0] + "," + d3.mouse(this)[1] + ")");
                focus.select('line.x')
                    .attr('x1', 0)
                    .attr('x2', -xScale(season))
                    .attr('y1', 0)
                    .attr('y2', 0);
                focus.select('line.y')
                    .attr('x1', xScale(season))
                    .attr('x2', xScale(season))
                    .attr('y1', 0)
                    .attr('y2', 450);
            }

            function mouseover() {
                for (k in teamTotals) {
                    kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                    d3.select('#' + kId).style('opacity', '0.25')
                    d3.select('#' + kId).style('pointer-events', 'all')
                }
                filterLines(topFilter)
                //focus.style('display', null)
                d3.select(this).style('opacity', '1')
            }

            function mouseout() {
                for (k in teamTotals) {
                    kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                    d3.select('#' + kId).style('opacity', '1')
                    d3.select('#' + kId).style('pointer-events', 'all')
                }
                filterLines(topFilter)
                d3.select(this).style('opacity', '1')
                div.transition()
                    .duration(200)
                    .style("opacity", 0);
                focus.style('opacity', 0)
            }
        }

        function drawComebackGraph() {
            var comebackSvg = d3.select('#comebackChart').append('svg').attr('height', '100%').attr('width', '100%');
            var yValues = [];
            var xValues = [];
            var marginValues = [];
            dataSet.forEach(function(d) {
                for (key in d) {
                    if (key !== 'season') {
                        xValues.push(d[key][0])
                        yValues.push(d[key][1]);
                        marginValues.push(d[key][2] / d[key][1])
                    }
                }
            });
            var yMin = d3.min(yValues, function(d, i) {
                return d;
            });
            var yMax = d3.max(yValues, function(d, i) {
                return d;
            });
            var xMin = d3.min(xValues, function(d, i) {
                return d;
            });
            var xMax = d3.max(xValues, function(d, i) {
                return d;
            });
            var mMin = d3.min(marginValues, function(d, i) {
                return d;
            });
            var mMax = d3.max(marginValues, function(d, i) {
                return d;
            });
            //console.log(xMin, xMax, yMin, yMax)
            var xScale = d3.scaleLinear()
                .domain([xMin, xMax])
                .range([40, 650]);
            var yScale = d3.scaleLinear()
                .domain([yMin, yMax])
                .range([315, 30]);
            //console.log(mMin, mMax)
            var mScale = d3.scaleLinear()
                .domain([mMin, mMax])
                .range([2, 80]);
            //console.log(seasons)
            var tScale = d3.scaleOrdinal()
                .domain(seasons)
                .range([40, 650])
            tScale.invert = (function() {
                var domain = tScale.domain()
                var range = tScale.range()
                var scale = d3.scaleQuantize().domain(range).range(domain)
                return function(x) {
                    return scale(x)
                }
            })()
            var xAxis = d3.axisBottom(xScale).ticks(6);
            var yAxis = d3.axisLeft(yScale);
            var xAxisG = comebackSvg.append('g')
                .attr('id', 'xAxisG')
                .attr('transform', 'translate(0,315)') //???
                .call(xAxis);
            var yAxisG = comebackSvg.append('g')
                .attr('id', 'yAxisG')
                .attr('transform', 'translate(40,0)') //???
                .call(yAxis);

            comebackSvg.append("text")
                .attr('transform', 'translate(300,350)')
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("Total Number of Wins");
            comebackSvg.append("text")
                .attr('transform', 'translate(10,150)rotate(-90)')
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("Number of Matches");
            var color = {
                'Liverpool': '#4d4d4d',
                'Man United': '#5da5da',
                'Arsenal': '#faa43a',
                'Barcelona': '#60bd68',
                'Real Madrid': '#f17cb0',
                'Inter': '#b2912f',
                'Lyon': '#b276b2',
                'Juventus': '#decf3f',
                'Chelsea': '#f15854',
                'Bayern Munich': '#1f77b4'
            }
            var linesG = comebackSvg.append('g');
            var legend = comebackSvg.append('g')
                .attr('id', 'legend')
                .attr('transform', 'translate(60, 250)')
                .style('opacity', '0');
            for (var i = 0; i < 5; i++) {
                legend.append('rect')
                    .attr('class', 'legend-text')
                    .attr('fill', color[Object.keys(color)[i]])
                    .attr('x', function() {
                        return 60 * i + 120;
                    })
                    .attr('height', 20)
                    .attr('width', 20)
                    .attr('y', 5);
                legend.append('text')
                    .attr('id', 'text' + Object.keys(color)[i])
                    .attr('class', 'legend-text')
                    .attr('fill', 'black')
                    .attr('x', function() {
                        return 60 * i + 143;
                    })
                    .attr('y', 20);
            }
            var dateText = legend.append('text')
                .attr('id', 'date-text')
                .attr('class', 'legend-text')
                .attr('x', 0)
                .attr('y', 20);
            var lines = {};
            var paths = {};
            var index = Object.keys(dataSet[0]).length - 1;
            var lastRow = dataSet[dataSet.length - 1]
            //console.log(lastRow)
            var colorCircle = 0
            for (key in lastRow) {
                if (key !== 'season') {
                    colorCircle += 1
                    comebackSvg.append("circle") // Uses the enter().append() method
                        .attr("class", "dot" + key.replace(/^[^a-z]+|[^\w:.-]+/gi, "")) // Assign a class for styling
                        .attr("cx", function(d, i) {
                            return xScale(dataSet[0][key][0])
                        })
                        .attr("cy", function(d) {
                            return yScale(dataSet[0][key][1])
                        })
                        .attr('fill', color[key])
                        .attr('fill-opacity', 0.5)
                        .attr('title', key)
                        .attr('stroke', color[key])
                        .attr("r", function() {
                            if (dataSet[0][key][1] == 0) {
                                return 1
                            }
                            return mScale(dataSet[0][key][2] / dataSet[0][key][1])
                        })
                        .attr("id", key.replace(/^[^a-z]+|[^\w:.-]+/gi, ""))
                        .on("mouseover", mouseover)
                        .on("mouseout", mouseout);
                }
            }
            var colorCircle = 0
            for (key in lastRow) {
                if (key !== 'season') {
                    colorCircle += 1

                    comebackSvg.selectAll(".dot" + key.replace(/^[^a-z]+|[^\w:.-]+/gi, ""))
                        .transition() // Transition from old to new
                        .duration(8000) // Length of animation
                        .ease(d3.easeBounce)
                        .attr("cx", function(d, i) {
                            return xScale(lastRow[key][0])
                        })
                        .attr("cy", function(d) {
                            return yScale(lastRow[key][1])
                        })
                        .attr('fill', color[key])
                        .attr('fill-opacity', 0.5)
                        .attr('title', key)
                        .attr('stroke', color[key])
                        .attr("r", function() {
                            if (lastRow[key][1] == 0) {
                                return 1
                            }
                            return mScale(lastRow[key][2] / lastRow[key][1])
                        })
                }
            }

            function drawLines() {
                for (key in dataSet[0]) {
                    if (key !== 'season') {
                        var line = d3.line()
                            .x(function(d) {
                                return xScale(d[key][0]);
                            })
                            .y(function(d) {
                                return yScale(d[key][1]);
                            })
                            .curve(d3.curveCatmullRom.alpha(0.5));
                        lines[key] = line;
                        index--;

                    }
                }
                filterLines(11)
            }
            drawLines()
            var bisectDate = d3.bisector(function(d, key) {
                return d.season;
            }).left;

            function mousemove() {
                var x = d3.mouse(this)[0];
                var team = d3.select(this).attr('title')
                var season = tScale.invert(d3.mouse(this)[0])
                console.log(season)
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div.html("Team: " + team + "<br> Comebacks: " + dataBank[season][team][1] + "<br> Wins: " + dataBank[season][team][0] + "<br> Season: " + season)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                focus.style('opacity', 0.8)
                focus.attr('transform', "translate(" + d3.mouse(this)[0] + "," + d3.mouse(this)[1] + ")");
                focus.select('line.x')
                    .attr('x1', 0)
                    .attr('x2', -d3.mouse(this)[0])
                    .attr('y1', 0)
                    .attr('y2', 0);
                focus.select('line.y')
                    .attr('x1', 0)
                    .attr('x2', 0)
                    .attr('y1', 0)
                    .attr('y2', 450 - d3.mouse(this)[1]);
            }

            function mouseover() {
                $("#myCarousel").carousel("pause");
                d3.selectAll(".highLightSvg").transition().duration(200).attr("opacity",0)
                for (k in teamTotals) {
                    kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                    d3.selectAll('#' + kId).style('opacity', '0.25')
                    d3.selectAll('#' + kId).style('pointer-events', 'all')
                }
                filterLines(topFilter)
                //focus.style('display', null)
                d3.select(this).style('opacity', '1')
                var team = d3.select(this).attr('title')
                var id = d3.select(this).attr('id')
                console.log(id)
                d3.selectAll('#' + id).style('opacity', '1')
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div.html("Team: " + team + "<br> Comebacks: " + lastRow[team][1] + "<br> Wins: " + lastRow[team][0] + "<br> Average Margin: " + (lastRow[team][2] / lastRow[team][1]).toFixed(2))
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            }

            function mouseout() {
                for (k in teamTotals) {
                    kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                    d3.selectAll('#' + kId).style('opacity', '1')
                    d3.selectAll('#' + kId).style('pointer-events', 'all')
                }
                filterLines(topFilter)
                d3.select(this).style('opacity', '1')
                div.transition()
                    .duration(200)
                    .style("opacity", 0);
            }
        }

        function filterLines(n) {
            var props = Object.keys(teamTotals).map(function(key) {
                return {
                    key: key,
                    value: this[key][0]
                };
            }, teamTotals);
            props.sort(function(p1, p2) {
                return p2.value - p1.value;
            });
            var topSet = props.slice(0, n).reduce(function(obj, prop) {
                obj[prop.key] = prop.value;
                return obj;
            }, {});
            for (k in teamTotals) {
                if (!(k in topSet)) {
                    kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                    d3.selectAll('#' + kId).style('opacity', '0')
                    d3.selectAll('#' + kId).style('pointer-events', 'none')
                }
            }
            d3.select("#topFilter").on("input", function() {
                for (k in teamTotals) {
                    kId = k.replace(/^[^a-z]+|[^\w:.-]+/gi, "")
                    d3.selectAll('#' + kId).style('opacity', '1')
                    d3.selectAll('#' + kId).style('pointer-events', 'all')
                }
                topFilter = +this.value + 1
                filterLines(topFilter);
            });
        }

        //slope graph
        var margin = {
            top: 100,
            right: 850,
            bottom: 40,
            left: 850
        };
        var width = 1800 - margin.left - margin.right,
            height = 460 - margin.top - margin.bottom;
        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + 200 + "," + margin.top + ")");
        var dictTeams = {}
        var y1 = d3.scaleLinear()
            .range([height, 0]);
        var y1Pos = d3.scaleLinear()
            .range([height, 0]);
        var y1Foul = d3.scaleLinear()
            .range([height, 0]);
        var config = {
            xOffset: 0,
            yOffset: 0,
            width: width,
            height: height,
            labelPositioning: {
                alpha: 0.5,
                spacing: 18
            },
            leftTitle: "Shots before Comeback",
            rightTitle: "Shots after Comeback",
            labelGroupOffset: 5,
            labelKeyOffset: 50,
            radius: 6,
            unfocusOpacity: 1
        }
        d3.csv("top10.csv", function(error, data) {
            if (error) return error;
            for (i = 0; i < data.length; i++) {
                if (data[i].comeback in dictTeams) {
                    dictTeams[data[i].comeback] = {
                        HTShots: dictTeams[data[i].comeback]['HTShots'] + parseInt(data[i].ShotsHTOfWonTeam),
                        FTShots: dictTeams[data[i].comeback]['FTShots'] + parseInt(data[i].ShotsFTOfWonTeam),
                        HTPossession: dictTeams[data[i].comeback]['HTPossession'] + parseInt(data[i].PossesionHTOfWonTeam),
                        FTPossession: dictTeams[data[i].comeback]['FTPossession'] + parseInt(data[i].PossesionFTOfWonTeam),
                        HTFoul: dictTeams[data[i].comeback]['HTFoul'] + parseInt(data[i].FoulsCommittedHTLostTeam),
                        FTFoul: dictTeams[data[i].comeback]['FTFoul'] + parseInt(data[i].FoulsCommittedFTLostTeam),
                        count: dictTeams[data[i].comeback]['count'] + 1
                    }
                } else {
                    dictTeams[data[i].comeback] = {
                        HTShots: parseInt(data[i].ShotsHTOfWonTeam),
                        FTShots: parseInt(data[i].ShotsFTOfWonTeam),
                        HTPossession: parseInt(data[i].PossesionHTOfWonTeam),
                        FTPossession: parseInt(data[i].PossesionFTOfWonTeam),
                        HTFoul: parseInt(data[i].FoulsCommittedHTLostTeam),
                        FTFoul: parseInt(data[i].FoulsCommittedFTLostTeam),
                        count: 1
                    }
                }
            }
            var color = {
                'Liverpool': '#4d4d4d',
                'Man Utd': '#5da5da',
                'Arsenal': '#faa43a',
                'Barcelona': '#60bd68',
                'Real Madrid': '#f17cb0',
                'Inter': '#b2912f',
                'Lyon': '#b276b2',
                'Juventus': '#decf3f',
                'Chelsea': '#f15854',
                'Bayern': '#1f77b4'
            }
            // Combine ratios into a single array
            var i = 0
            var ratios = [];
            var shotRange = [];
            var possessionRange = [];
            var foulRange = [];
            for (var teamName in dictTeams) {
                dictTeams[teamName]['name'] = teamName
                dictTeams[teamName]['FTShots'] = (dictTeams[teamName]['FTShots'] - dictTeams[teamName]['HTShots']) / dictTeams[teamName]['count']
                dictTeams[teamName]['HTShots'] = dictTeams[teamName]['HTShots'] / dictTeams[teamName]['count']
                dictTeams[teamName]['FTPossession'] = (dictTeams[teamName]['FTPossession']) / (dictTeams[teamName]['count'])
                dictTeams[teamName]['HTPossession'] = dictTeams[teamName]['HTPossession'] / (dictTeams[teamName]['count'])
                dictTeams[teamName]['FTFoul'] = (dictTeams[teamName]['FTFoul'] - dictTeams[teamName]['HTFoul']) / (dictTeams[teamName]['count'])
                dictTeams[teamName]['HTFoul'] = dictTeams[teamName]['HTFoul'] / (dictTeams[teamName]['count'])
                ratios.push(dictTeams[teamName]);
                shotRange[i] = dictTeams[teamName]['HTShots'];
                shotRange[i + 10] = dictTeams[teamName]['FTShots'];
                possessionRange[i] = dictTeams[teamName]['HTPossession'];
                possessionRange[i + 10] = dictTeams[teamName]['FTPossession'];
                foulRange[i] = dictTeams[teamName]['HTFoul'];
                foulRange[i + 10] = dictTeams[teamName]['FTFoul'];
                i += 1
            }
            // Nest by university
            var nestedByName = d3.nest()
                .key(function(d) {
                    return d.name
                })
                .entries(ratios);
            shotRange.sort(function(a, b) {
                return a - b
            })
            possessionRange.sort(function(a, b) {
                return a - b
            })
            foulRange.sort(function(a, b) {
                return a - b
            })
            var y1Min = shotRange[0]
            var y1Max = shotRange[shotRange.length - 1]
            var y1MinPos = possessionRange[0]
            var y1MaxPos = possessionRange[possessionRange.length - 1]
            var y1MinFoul = foulRange[0]
            var y1MaxFoul = foulRange[foulRange.length - 1]
            y1.domain([y1Min, y1Max]);
            y1Pos.domain([y1MinPos, y1MaxPos])
            y1Foul.domain([y1MinFoul, y1MaxFoul])
            var yScale = y1;
            var yscalePos = y1Pos;
            var yscaleFoul = y1Foul;
            var voronoi = d3.voronoi()
                .x(d => d.HTShots > 0 ? 0 : width)
                .y(d => yScale(d.HTShots > 0 ? d.HTShots : d.FTShots))
                .extent([
                    [-margin.left, -margin.top],
                    [width + margin.right, height + margin.bottom]
                ]);
            var voronoiPossession = d3.voronoi()
                .x(d => d.HTPossession > 0 ? 0 : width)
                .y(d => yscalePos(d.HTPossession > 0 ? d.HTPossession : d.FTPossession))
                .extent([
                    [-margin.left, -margin.top],
                    [width + margin.right, height + margin.bottom]
                ]);
            var voronoiFoul = d3.voronoi()
                .x(d => d.HTFoul > 0 ? 0 : width)
                .y(d => yscaleFoul(d.HTFoul > 0 ? d.HTFoul : d.FTFoul))
                .extent([
                    [-margin.left, -margin.top],
                    [width + margin.right, height + margin.bottom]
                ]);

            var borderLines = svg.append("g")
                .attr("class", "border-lines")
            borderLines.append("line")
                .attr("x1", 0).attr("y1", 0)
                .attr("x2", 0).attr("y2", config.height);
            borderLines.append("line")
                .attr("x1", width).attr("y1", 0)
                .attr("x2", width).attr("y2", config.height);

            var borderLines = svg.append("g")
                .attr("class", "border-lines")
            borderLines.append("line")
                .attr("x1", width + 350).attr("y1", 0)
                .attr("x2", width + 350).attr("y2", config.height);
            borderLines.append("line")
                .attr("x1", width + width + 350).attr("y1", 0)
                .attr("x2", width + width + 350).attr("y2", config.height);

            var borderLines = svg.append("g")
                .attr("class", "border-lines")
            borderLines.append("line")
                .attr("x1", width + width + 350 + 350).attr("y1", 0)
                .attr("x2", width + width + 350 + 350).attr("y2", config.height);
            borderLines.append("line")
                .attr("x1", width + width + width + 350 + 350).attr("y1", 0)
                .attr("x2", width + width + width + 350 + 350).attr("y2", config.height);
            
            console.log(nestedByName)
            var slopeGroups = svg.append("g")
                .selectAll("g")
                .data(nestedByName)
                .enter().append("g")
                .attr("class", "slope-group")
                //.attr("id", d.key);
                .attr("id", function(d, i) {
                    console.log(d)
                    console.log(i)
                    d.id = "group" + i;
                    d.values[0].group = this;
                    console.log(d.values[0])
		    if (d.values[0].name === "Man Utd"){return "ManUnited"}
		    if (d.values[0].name === "Bayern"){return "BayernMunich"}
		    if (d.values[0].name === "Real Madrid"){return "RealMadrid"}
                    return d.values[0].name
                });

            var slopeLines = slopeGroups.append("line")
                .attr("class", "slope-line")
                .attr("x1", 0)
                .attr("y1", function(d) {
                    return y1(d.values[0].HTShots);
                })
                .attr("x2", config.width)
                .attr("y2", function(d) {
                    return y1(d.values[0].FTShots);
                })
                .attr('stroke', function(d) {
                    return color[d.key];
                });

            var slopeLines = slopeGroups.append("line")
                .attr("class", "slope-line")
                .attr("x1", width + 350)
                .attr("y1", function(d) {
                    return y1Pos(d.values[0].HTPossession);
                })
                .attr("x2", config.width + config.width + 350)
                .attr("y2", function(d) {
                    return y1Pos(d.values[0].FTPossession);
                })
                .attr('stroke', function(d) {
                    return color[d.key];
                });

            var slopeLines = slopeGroups.append("line")
                .attr("class", "slope-line")
                .attr("x1", config.width + config.width + 350 + 350)
                .attr("y1", function(d) {
                    return y1Foul(d.values[0].HTFoul);
                })
                .attr("x2", config.width + config.width + config.width + 350 + 350)
                .attr("y2", function(d) {
                    return y1Foul(d.values[0].FTFoul);
                })
                .attr('stroke', function(d) {
                    return color[d.key];
                });

            var leftSlopeCircle = slopeGroups.append("circle")
                .attr("r", config.radius)
                .attr("cy", d => y1(d.values[0].HTShots));

            var leftSlopeCircle = slopeGroups.append("circle")
                .attr("r", config.radius)
                .attr("cx", width + 350)
                .attr("cy", d => y1Pos(d.values[0].HTPossession));

            var leftSlopeCircle = slopeGroups.append("circle")
                .attr("r", config.radius)
                .attr("cx", width + width + 350 + 350)
                .attr("cy", d => y1Foul(d.values[0].HTFoul));

            var leftSlopeLabels = slopeGroups.append("g")
                .attr("class", "slope-label-left")
                .each(function(d) {
                    d.xLeftPosition = -config.labelGroupOffset;
                    d.yLeftPosition = y1(d.values[0].HTShots);
                });

            leftSlopeLabels.append("text")
                .attr("class", "label-figure")
                .attr("x", d => d.xLeftPosition)
                .attr("y", d => d.yLeftPosition)
                .attr("dx", -10)
                .attr("dy", 3)
                .attr("text-anchor", "end")
                .text(d => (d.values[0].HTShots).toPrecision(3));

            leftSlopeLabels.append("text")
                .attr("x", d => d.xLeftPosition)
                .attr("y", d => d.yLeftPosition)
                .attr("dx", -config.labelKeyOffset)
                .attr("dy", 3)
                .attr("text-anchor", "end")
                .text(d => d.key);

            var leftSlopeLabels = slopeGroups.append("g")
                .attr("class", "slope-label-left")
                .each(function(d) {
                    d.xLeftPosition = width + 350 + config.labelGroupOffset;
                    d.yLeftPosition = y1Pos(d.values[0].HTPossession);
                });

            leftSlopeLabels.append("text")
                .attr("class", "label-figure")
                .attr("x", d => d.xLeftPosition)
                .attr("y", d => d.yLeftPosition)
                .attr("dx", -10)
                .attr("dy", 3)
                .attr("text-anchor", "end")
                .text(d => (d.values[0].HTPossession).toPrecision(3));

            leftSlopeLabels.append("text")
                .attr("x", d => d.xLeftPosition)
                .attr("y", d => d.yLeftPosition)
                .attr("dx", -config.labelKeyOffset)
                .attr("dy", 3)
                .attr("text-anchor", "end")
                .text(d => d.key)

            var leftSlopeLabels = slopeGroups.append("g")
                .attr("class", "slope-label-left")
                .each(function(d) {
                    d.xLeftPosition = width + 350 + width + 350 + config.labelGroupOffset;
                    d.yLeftPosition = y1Foul(d.values[0].HTFoul);
                });

            leftSlopeLabels.append("text")
                .attr("class", "label-figure")
                .attr("x", d => d.xLeftPosition)
                .attr("y", d => d.yLeftPosition)
                .attr("dx", -10)
                .attr("dy", 3)
                .attr("text-anchor", "end")
                .text(d => (d.values[0].HTFoul).toPrecision(3));

            leftSlopeLabels.append("text")
                .attr("x", d => d.xLeftPosition)
                .attr("y", d => d.yLeftPosition)
                .attr("dx", -config.labelKeyOffset)
                .attr("dy", 3)
                .attr("text-anchor", "end")
                .text(d => d.key)

            var rightSlopeCircle = slopeGroups.append("circle")
                .attr("r", config.radius)
                .attr("cx", config.width)
                .attr("cy", d => y1(d.values[0].FTShots));

            var rightSlopeLabels = slopeGroups.append("g")
                .attr("class", "slope-label-right")
                .each(function(d) {
                    d.xRightPosition = width + config.labelGroupOffset;
                    d.yRightPosition = y1(d.values[0].FTShots);
                });

            rightSlopeLabels.append("text")
                .attr("class", "label-figure")
                .attr("x", d => d.xRightPosition)
                .attr("y", d => d.yRightPosition)
                .attr("dx", 10)
                .attr("dy", 3)
                .attr("text-anchor", "start")
                .text(d => (d.values[0].FTShots).toPrecision(3));

            rightSlopeLabels.append("text")
                .attr("x", d => d.xRightPosition)
                .attr("y", d => d.yRightPosition)
                .attr("dx", config.labelKeyOffset)
                .attr("dy", 3)
                .attr("text-anchor", "start")
                .text(d => d.key);

            var rightSlopeCircle = slopeGroups.append("circle")
                .attr("r", config.radius)
                .attr("cx", width + 350 + config.width)
                .attr("cy", d => y1Pos(d.values[0].FTPossession));

            var rightSlopeLabels = slopeGroups.append("g")
                .attr("class", "slope-label-right")
                .each(function(d) {
                    d.xRightPosition = width + 350 + width + config.labelGroupOffset;
                    d.yRightPosition = y1Pos(d.values[0].FTPossession);
                });

            rightSlopeLabels.append("text")
                .attr("class", "label-figure")
                .attr("x", d => d.xRightPosition)
                .attr("y", d => d.yRightPosition)
                .attr("dx", 10)
                .attr("dy", 3)
                .attr("text-anchor", "start")
                .text(d => (d.values[0].FTPossession).toPrecision(3));

            rightSlopeLabels.append("text")
                .attr("x", d => d.xRightPosition)
                .attr("y", d => d.yRightPosition)
                .attr("dx", config.labelKeyOffset)
                .attr("dy", 3)
                .attr("text-anchor", "start")
                .text(d => d.key);

            var rightSlopeCircle = slopeGroups.append("circle")
                .attr("r", config.radius)
                .attr("cx", width + 350 + width + 350 + config.width)
                .attr("cy", d => y1Foul(d.values[0].FTFoul));

            var rightSlopeLabels = slopeGroups.append("g")
                .attr("class", "slope-label-right")
                .each(function(d) {
                    d.xRightPosition = width + 350 + width + 350 + width + config.labelGroupOffset;
                    d.yRightPosition = y1Foul(d.values[0].FTFoul);
                });

            rightSlopeLabels.append("text")
                .attr("class", "label-figure")
                .attr("x", d => d.xRightPosition)
                .attr("y", d => d.yRightPosition)
                .attr("dx", 10)
                .attr("dy", 3)
                .attr("text-anchor", "start")
                .text(d => (d.values[0].FTFoul).toPrecision(3));

            rightSlopeLabels.append("text")
                .attr("x", d => d.xRightPosition)
                .attr("y", d => d.yRightPosition)
                .attr("dx", config.labelKeyOffset)
                .attr("dy", 3)
                .attr("text-anchor", "start")
                .text(d => d.key);

            var titles = svg.append("g")
                .attr("class", "title");

            titles.append("text")
                .attr("text-anchor", "end")
                .attr("dx", -10)
                .attr("dy", -margin.top / 2)
                .text(config.leftTitle);

            titles.append("text")
                .attr("x", config.width)
                .attr("dx", 10)
                .attr("dy", -margin.top / 2)
                .text(config.rightTitle);

            titles.append("text")
                .attr("text-anchor", "end")
                .attr("x", 350 + config.width)
                .attr("dx", -10)
                .attr("dy", -margin.top / 2)
                .text("Possesion before Comeback");

            titles.append("text")
                .attr("x", 350 + config.width + config.width)
                .attr("dx", 10)
                .attr("dy", -margin.top / 2)
                .text("Possesion after Comeback");

            titles.append("text")
                .attr("text-anchor", "end")
                .attr("x", 350 + config.width + 350 + config.width)
                .attr("dx", -10)
                .attr("dy", -margin.top / 2)
                .text("Opponent Fouls before Comeback");

            titles.append("text")
                .attr("x", 350 + config.width + config.width + 350 + config.width)
                .attr("dx", 10)
                .attr("dy", -margin.top / 2)
                .text("Opponent Fouls after Comeback");

            relax(leftSlopeLabels, "yLeftPosition");
            leftSlopeLabels.selectAll("text")
                .attr("y", d => d.yLeftPosition);

            relax(rightSlopeLabels, "yRightPosition");
            rightSlopeLabels.selectAll("text")
                .attr("y", d => d.yRightPosition);

            d3.selectAll(".slope-group")
                .attr("opacity", config.unfocusOpacity);

            var voronoiGroup = svg.append("g")
                .attr("class", "voronoi");

            var voronoiGroupPossession = svg.append("g")
                .attr("class", "voronoi");

            var voronoiGroupFoul = svg.append("g")
                .attr("class", "voronoi");

            voronoiGroup.selectAll("path")
                .data(voronoi.polygons(d3.merge(nestedByName.map(d => d.values))))
                .enter().append("path")
                .attr("d", function(d) {
                    return d ? "M" + d.join("L") + "Z" : null;
                })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout);

            voronoiGroupPossession.selectAll("path")
                .data(voronoiPossession.polygons(d3.merge(nestedByName.map(d => d.values))))
                .enter().append("path")
                .attr("d", function(d) {
                    return d ? "M" + d.join("L") + "Z" : null;
                })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout);

            voronoiGroupFoul.selectAll("path")
                .data(voronoiFoul.polygons(d3.merge(nestedByName.map(d => d.values))))
                .enter().append("path")
                .attr("d", function(d) {
                    return d ? "M" + d.join("L") + "Z" : null;
                })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout);
        });


        function mouseover(d) {
            console.log(d.data.group.id)
	    id = d.data.group.id
            //d3.select(d.data.group.id).attr("opacity", 1);
	    //var id = d3.select(this).attr('id')
            console.log(id)
	    d3.selectAll(".slope-group")
                .attr("opacity", 0.3);
            d3.selectAll('#' + id).style('opacity', '1')
        }

        function mouseout(d) {
            d3.selectAll(".slope-group")
                .attr("opacity", config.unfocusOpacity);
        }

        // Function to reposition an array selection of labels (in the y-axis)
        function relax(labels, position) {
            again = false;
            labels.each(function(d, i) {
                a = this;
                da = d3.select(a).datum();
                y1 = da[position];
                labels.each(function(d, j) {
                    b = this;
                    if (a == b) return;
                    db = d3.select(b).datum();
                    y2 = db[position];
                    deltaY = y1 - y2;
                    if (Math.abs(deltaY) > config.labelPositioning.spacing)
                        return;
                    again = true;
                    sign = deltaY > 0 ? 1 : -1;
                    adjust = sign * config.labelPositioning.alpha;
                    da[position] = +y1 + adjust;
                    db[position] = +y2 - adjust;
                    if (again) {
                        relax(labels, position);
                    }
                })
            })
        }

    </script>

</body>
